version: '3.8'

services:
  recipes:
    container_name: 'recipes'
    image: 'vabene1111/recipes:latest'
    restart: 'unless-stopped'
    volumes:
      - '/etc/timezone:/etc/timezone:ro'
      - '/etc/localtime:/etc/localtime:ro'
      - 'recipes-media:/opt/recipes/mediafiles/'
    environment:
      SECRET_KEY: '${RECIPES_SECRET_KEY}'
      DB_ENGINE: 'django.db.backends.postgresql'
      POSTGRES_HOST: 'recipes-db'
      POSTGRES_PORT: '5432'
      POSTGRES_USER: 'recipes-user'
      POSTGRES_PASSWORD: '${RECIPES_POSTGRES_PASSWORD}'
      POSTGRES_DB: 'recipes'
      # REVERSE_PROXY_AUTH: '1'
      # PROXY_HEADER: 'X-Forwarded-User'
      VIRTUAL_HOST: 'https://recipes.${DOMAIN_SUFFIX}'
      GUNICORN_MEDIA: '0'
      DEBUG: '0'
      MEDIA_URL: 'https://media.recipes.${DOMAIN_SUFFIX}'
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.recipes.rule=Host(`recipes.${DOMAIN_SUFFIX}`)'
      - 'traefik.http.routers.recipes.entrypoints=websecure'
      - 'traefik.http.routers.recipes.tls=true'
      - 'traefik.http.routers.recipes.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.recipes.tls.domains[0].main=recipes.${DOMAIN_SUFFIX}'
      - 'traefik.http.routers.recipes.middlewares=default@file'
      - 'traefik.http.services.recipes.loadbalancer.server.port=8080'

  recipes-media:
    container_name: 'recipes-media'
    image: 'nginx:latest'
    restart: 'unless-stopped'
    volumes:
      - '/etc/timezone:/etc/timezone:ro'
      - '/etc/localtime:/etc/localtime:ro'
      - './nginx/:/etc/nginx/conf.d/:ro'
      - 'recipes-media:/media/'
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.recipes-media.rule=Host(`media.recipes.${DOMAIN_SUFFIX}`)'
      - 'traefik.http.routers.recipes-media.entrypoints=websecure'
      - 'traefik.http.routers.recipes-media.tls=true'
      - 'traefik.http.routers.recipes-media.tls.certresolver=letsencrypt'
      - 'traefik.http.routers.recipes-media.tls.domains[0].main=media.recipes.${DOMAIN_SUFFIX}'
      - 'traefik.http.routers.recipes-media.middlewares=default@file'
      - 'traefik.http.services.recipes-media.loadbalancer.server.port=80'

  recipes-db:
    container_name: 'recipes-db'
    image: 'postgres'
    restart: 'unless-stopped'
    volumes:
      - '/etc/timezone:/etc/timezone:ro'
      - '/etc/localtime:/etc/localtime:ro'
      - 'recipes-db:/var/lib/postgresql/data'
    environment:
      POSTGRES_DB: 'recipes'
      POSTGRES_USER: 'recipes-user'
      POSTGRES_PASSWORD: '${RECIPES_POSTGRES_PASSWORD}'
